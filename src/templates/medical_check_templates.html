{% extends '_base.html' %}
{% set page_title = "Medical Check Templates" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Medical Check Templates</h2>
    <a href="/admin/medical_check_templates/new" class="btn btn-primary">+ New Check Template</a>
  </div>

  <input type="text" id="searchInput" class="form-control" placeholder="Search templates...">

  <div class="table-responsive mt-3">
    <table id="activeTemplatesTable" class="table table-striped table-hover align-middle">
      <thead class="table-primary">
      <tr>
        <th>Name</th>
        <th>Fields</th>
        <th style="width: 120px;">Actions</th>
      </tr>
      </thead>
      <tbody>
      {% if active_templates and active_templates|length > 0 %}
        {% for t in active_templates %}
          <tr data-href="/admin/medical_check_templates/{{ t.template_id }}/edit" style="cursor: pointer;">
            <td>{{ t.name }}</td>
            <td>
              {# Show comma-separated parameter names #}
              {% if t.items and t.items|length > 0 %}
                {{ t.items | map(attribute='name') | join(', ') }}
              {% else %}
                <span class="text-muted">No fields</span>
              {% endif %}
            </td>
            <td>
              <form action="/admin/medical_check_templates/{{ t.template_id }}/deactivate" method="POST" class="d-inline">
                <button type="submit" class="btn btn-sm btn-outline-danger">Deactivate</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="3" class="text-center text-muted py-4">No active check types.</td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>

  <div class="mt-5">
    <button class="btn btn-outline-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#deactivatedTemplatesCollapse" aria-expanded="false" aria-controls="deactivatedTemplatesCollapse">
      Deactivated Templates ({{ deactivated_types|length }})
    </button>
    <div class="collapse" id="deactivatedTemplatesCollapse">
      <div class="table-responsive">
        <table id="deactivatedTemplatesTable" class="table table-striped table-hover align-middle">
          <thead class="table-secondary">
          <tr>
            <th>Name</th>
            <th>Fields</th>
            <th style="width: 120px;">Actions</th>
          </tr>
          </thead>
          <tbody>
          {% if deactivated_types and deactivated_types|length > 0 %}
            {% for t in deactivated_types %}
            <tr data-href="/admin/medical_check_templates/{{ t.template_id }}/edit" style="cursor: pointer;">
                <td>{{ t.name }}</td>
                <td>
                  {% if t.items and t.items|length > 0 %}
                    {{ t.items | map(attribute='name') | join(', ') }}
                  {% else %}
                    <span class="text-muted">No fields</span>
                  {% endif %}
                </td>
                <td>
                  <form action="/admin/medical_check_templates/{{ t.template_id }}/activate" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-success">Activate</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="3" class="text-center text-muted py-4">No deactivated check types.</td>
            </tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    document.getElementById("searchInput").addEventListener("input", function () {
      const query = this.value.toLowerCase();
      const rows = document.querySelectorAll("table tbody tr");
      rows.forEach(row => {
        const visible = Array.from(row.children).some(td =>
          td.textContent.toLowerCase().includes(query)
        );
        row.style.display = visible ? "" : "none";
      });
    });

    // Make rows clickable to open view page; ignore clicks on links/buttons (if any appear in future)
    document.querySelectorAll('table tbody').forEach(tbody => {
        tbody.addEventListener('click', function (e) {
          if (e.target.closest('a, button, form')) {
            return;
          }
          const row = e.target.closest('tr[data-href]');
          if (row) {
            window.location.href = row.getAttribute('data-href');
          }
        });
    });
  </script>
{% endblock %}
