{% extends '_base.html' %}
{% set page_title = "Patient Details" %}

{% block content %}
    <div class="row g-3">
        <!-- Left column -->
        <div class="col-md-6">
            {% include '_patient_summary_card.html' %}

            <!-- Dynamic chart tiles -->
            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">Charts</div>
                <div class="card-body">
                    <!-- Add tile controls -->
                    <div class="row g-2 align-items-end mb-3">
                        <div class="col-auto">
                            <label for="chartOption" class="form-label">Chart item</label>
                            <select id="chartOption" class="form-select">
                                <!-- options populated dynamically as: name -> item_name -->
                            </select>
                        </div>
                        <div class="col-auto">
                            <button id="addChartTileBtn" class="btn btn-primary">Add Tile</button>
                        </div>
                    </div>

                    <!-- Tiles grid -->
                    <div id="chartTiles" class="row row-cols-1 g-3">
                        <!-- tiles injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right column -->
        <div class="col-md-6">
            <!-- Combined controls + history -->
            <div class="card">
                <div class="card-header bg-info text-white">Medical checks</div>
                <div class="card-body">
                    <!-- Top: Add control -->
                    <div class="d-flex gap-2 align-items-center flex-wrap mb-3">
                        <select id="checkType" class="form-select" style="max-width: 320px;">
                            {% for t in templates or [] %}
                                <option value="{{ t.type_id }}">{{ t.name }}</option>
                            {% endfor %}
                        </select>
                        <button id="addRecordBtn" class="btn btn-primary">Add Record</button>
                    </div>

                    <!-- Bottom: tiles list -->
                    <div id="noRecords" class="text-muted" style="display:none;">No records yet.</div>
                    <div id="checksTiles" class="row row-cols-1 g-2">
                        <!-- populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const patientId = {{ patient.patient_id }};
            const tiles = document.getElementById('checksTiles');
            const noRecords = document.getElementById('noRecords');
            const chartTiles = document.getElementById('chartTiles');
            const addChartTileBtn = document.getElementById('addChartTileBtn');
            const chartOption = document.getElementById('chartOption');

            // Hold available options for current patient (from backend)
            // Array of {check_template, item_name, label}
            let chartableOptions = [];

            function render(records) {
                tiles.innerHTML = '';
                if (!records || records.length === 0) {
                    noRecords.style.display = '';
                    return;
                }
                noRecords.style.display = 'none';
                for (const r of records) {
                    const col = document.createElement('div');
                    col.className = 'col';

                    const card = document.createElement('div');
                    card.className = 'border rounded py-2 px-3 d-flex justify-content-between align-items-center';
                    if (r.check_id) {
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => {
                            window.location.href = `/patients/${patientId}/medical_checks/${r.check_id}`;
                        });
                        card.title = 'View details';
                    }

                    const templateName = document.createElement('div');
                    templateName.className = 'fw-bold text-truncate';
                    templateName.textContent = r.template_name || '';

                    const date = document.createElement('div');
                    date.className = 'fw-bold ms-3';
                    date.textContent = r.check_date;

                    const sVal = r.status || '';
                    if (sVal === 'Red') {
                        card.classList.add('bg-danger', 'text-white');
                    } else if (sVal === 'Amber') {
                        card.classList.add('bg-warning', 'text-dark');
                    } else if (sVal === 'Green') {
                        card.classList.add('bg-success', 'text-white');
                    }

                    card.append(templateName, date);
                    col.appendChild(card);
                    tiles.appendChild(col);
                }
            }

            Promise.all([
                fetch(`/patients/${patientId}/medical_checks`).then(r => r.json()).catch(() => ({records: []})),
                fetch(`/patients/${patientId}/medical_checks/chartable_options`).then(r => r.json()).catch(() => ({records: []})),
            ])
                .then(([checksData, optionsData]) => {
                    const records = Array.isArray(checksData.records) ? checksData.records : [];
                    chartableOptions = Array.isArray(optionsData.records) ? optionsData.records : [];
                    populateChartOptionSelect();
                    updateChartsControlsState();
                    render(records);

                    // Auto-add default charts for physicals if available
                    tryAutoAddDefaultPhysicalsCharts();
                })
                .catch(() => {
                    // If failed, disable controls and render empty list
                    render([]);
                    updateChartsControlsState(true);
                });

            // Redirect to generic add page based on selected type
            document.getElementById('addRecordBtn').addEventListener('click', () => {
                const selectedTemplateId = document.getElementById('checkType').value;
                window.location.href = `/patients/${patientId}/medical_checks/new?check_template_id=${encodeURIComponent(selectedTemplateId)}`;
            });

            // --- Dynamic chart tiles ---
            const chartState = new Map(); // key -> { chart, el }

            function normalizeKey(type, name) {
                return `${type}::${(name || '').trim().toLowerCase()}`;
            }

            function createTileElement(type, name) {
                const col = document.createElement('div');
                col.className = 'col';

                const card = document.createElement('div');
                card.className = 'card shadow-sm';

                const header = document.createElement('div');
                header.className = 'card-header d-flex justify-content-between align-items-center';
                header.innerHTML = `<span class="fw-bold">${type} Â· ${name}</span>`;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-outline-danger';
                removeBtn.textContent = 'Remove';
                header.appendChild(removeBtn);

                const body = document.createElement('div');
                body.className = 'card-body';
                const canvas = document.createElement('canvas');
                canvas.height = 160;
                body.appendChild(canvas);

                card.append(header, body);
                col.appendChild(card);

                return { col, canvas, removeBtn };
            }

            function populateChartOptionSelect() {
                const current = chartOption.value;
                chartOption.innerHTML = '';
                for (const o of chartableOptions) {
                    const opt = document.createElement('option');
                    opt.value = JSON.stringify({ type: o.check_template, name: o.item_name });
                    opt.textContent = o.label || `${o.check_template} -> ${o.item_name}`;
                    chartOption.appendChild(opt);
                }
                if (current) chartOption.value = current;
            }

            function updateChartsControlsState(forceDisable = false) {
                const hasOptions = !forceDisable && Array.isArray(chartableOptions) && chartableOptions.length > 0;
                chartOption.disabled = !hasOptions;
                addChartTileBtn.disabled = !hasOptions;
            }

            async function fetchSeries(type, name) {
                const url = new URL(window.location.origin + `/patients/${patientId}/medical_checks/timeseries`);
                url.searchParams.set('check_template', type);
                url.searchParams.set('item_name', name);
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Failed to load time series');
                const data = await resp.json();
                return Array.isArray(data.records) ? data.records : [];
            }

            function toChartData(records) {
                // records: {date: YYYY-MM-DD, value: str, units: str}
                const labels = [];
                const values = [];
                for (const r of records) {
                    labels.push(r.date);
                    const v = parseFloat(String(r.value).replace(',', '.'));
                    values.push(Number.isFinite(v) ? v : null);
                }
                return { labels, values, unit: (records[0]?.units) || '' };
            }

            function renderChart(ctx, labels, values, label) {
                return new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label,
                            data: values,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.2,
                            spanGaps: true,
                            pointRadius: 3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: { autoSkip: true, maxTicksLimit: 8 }
                            },
                            y: {
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            }

            async function addTileWith(type, name) {
                if (!type || !name) return;
                const key = normalizeKey(type, name);
                if (chartState.has(key)) {
                    return; // already present
                }
                const { col, canvas, removeBtn } = createTileElement(type, name);
                chartTiles.appendChild(col);
                try {
                    const series = await fetchSeries(type, name);
                    const { labels, values, unit } = toChartData(series);
                    const chart = renderChart(canvas.getContext('2d'), labels, values, unit || name);
                    chartState.set(key, { chart, el: col });
                    removeBtn.addEventListener('click', () => removeTile(key));
                } catch (e) {
                    col.querySelector('.card-body').innerHTML = `<div class="text-danger">Failed to load data</div>`;
                }
            }

            async function addTile() {
                const raw = chartOption.value;
                if (!raw) {
                    alert('Please select a chart item');
                    return;
                }
                let parsed;
                try { parsed = JSON.parse(raw); } catch { parsed = null; }
                if (!parsed || !parsed.type || !parsed.name) return;
                await addTileWith(parsed.type, parsed.name);
            }

            function removeTile(key) {
                const state = chartState.get(key);
                if (!state) return;
                try { state.chart.destroy(); } catch (_) {}
                state.el.remove();
                chartState.delete(key);
            }

            addChartTileBtn.addEventListener('click', addTile);

            function tryAutoAddDefaultPhysicalsCharts() {
                const type = 'physicals';
                const available = chartableOptions.filter(o => String(o.check_template).toLowerCase() === type);
                if (available.length === 0) return;
                const want = [
                    'weight',
                    'blood pressure (diastolic)',
                    'blood pressure (systolic)',
                    'heart rate',
                ];
                for (const desired of want) {
                    const match = available.find(o => String(o.item_name).trim().toLowerCase() === desired);
                    if (match) addTileWith(match.check_template, match.item_name);
                }
            }
        });
    </script>
{% endblock %}
