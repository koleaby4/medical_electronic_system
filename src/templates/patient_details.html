{% extends '_base.html' %}
{% set page_title = "Patient Details" %}

{% block content %}
    <script>
        (function() {
            // Define addTileWith globally early so it can be called from partials during initial load
            window.addTileWith = function(type, name) {
                if (!window._earlyCharts) window._earlyCharts = [];
                window._earlyCharts.push({type, name});
            };
        })();
    </script>
    {% if request.query_params.get('ai_success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            Request sent to AI successfully and response stored.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}
    {% if request.query_params.get('ai_error') %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            Error calling AI: {{ request.query_params.get('ai_error') }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}
    <div class="row g-3" id="patient-details-container" data-patient-id="{{ patient.patient_id }}">
        <!-- Left column -->
        <div class="col-md-6">
            {% include '_patient_summary_card.html' %}

            <!-- Dynamic chart tiles -->
            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">Charts</div>
                <div class="card-body">
                    <!-- Add tile controls -->
                    <div class="row g-2 align-items-end mb-3">
                        <div class="col-auto">
                            <label for="chartOption" class="form-label">Chart item</label>
                            <select id="chartOption" class="form-select">
                                <option>Loading...</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button id="addChartTileBtn" class="btn btn-primary">Add Tile</button>
                        </div>
                    </div>

                    <!-- Tiles grid -->
                    <div id="chartTiles" class="row row-cols-1 g-3">
                        <!-- tiles injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right column -->
        <div class="col-md-6">
            <!-- Combined controls + history -->
            <div class="card">
                <div class="card-header bg-info text-white">Medical checks</div>
                <div class="card-body">
                    <!-- Top: Add control -->
                    <div class="d-flex gap-2 align-items-center flex-wrap mb-3">
                        <select id="checkType" name="check_template_id" class="form-select" style="max-width: 320px;">
                            {% for t in templates or [] %}
                                <option value="{{ t.template_id }}">{{ t.name }}</option>
                            {% endfor %}
                        </select>
                        <a id="addRecordBtn" class="btn btn-primary" 
                           href="#" 
                           onclick="this.href='/patients/{{ patient.patient_id }}/medical_checks/new?check_template_id=' + document.getElementById('checkType').value">Add Record</a>
                    </div>

                    <!-- Bottom: tiles list -->
                    <div id="checksTiles" class="row row-cols-1 g-2">
                        <div class="text-muted">Loading records...</div>
                    </div>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', async () => {
                    const patientId = '{{ patient.patient_id }}';
                    const container = document.getElementById('checksTiles');
                    
                    async function loadMedicalChecks() {
                        try {
                            const resp = await fetch(`/patients/${patientId}/medical_checks`);
                            if (!resp.ok) throw new Error('Failed to load medical checks');
                            const data = await resp.json();
                            
                            if (data.records && data.records.length > 0) {
                                container.innerHTML = '';
                                data.records.forEach(r => {
                                    const col = document.createElement('div');
                                    col.className = 'col';
                                    
                                    const statusClass = r.status === 'Red' ? 'bg-danger text-white' : 
                                                      r.status === 'Amber' ? 'bg-warning text-dark' : 
                                                      r.status === 'Green' ? 'bg-success text-white' : '';
                                    
                                    const div = document.createElement('div');
                                    div.className = `border rounded py-2 px-3 d-flex justify-content-between align-items-center ${statusClass}`;
                                    if (r.check_id) {
                                        div.style.cursor = 'pointer';
                                        div.onclick = () => window.location.href = `/patients/${patientId}/medical_checks/${r.check_id}`;
                                        div.title = 'View details';
                                    }
                                    
                                    div.innerHTML = `
                                        <div class="fw-bold text-truncate">${r.template_name || ''}</div>
                                        <div class="fw-bold ms-3">${r.check_date}</div>
                                    `;
                                    col.appendChild(div);
                                    container.appendChild(col);
                                });
                            } else {
                                container.innerHTML = '<div id="noRecords" class="text-muted">No records yet.</div>';
                            }
                        } catch (e) {
                            container.innerHTML = '<div class="text-danger">Failed to load records</div>';
                        }
                    }

                    async function loadChartableOptions() {
                        try {
                            const resp = await fetch(`/patients/${patientId}/medical_checks/chartable_options`, {
                                headers: { 'Accept': 'application/json' }
                            });
                            if (!resp.ok) throw new Error('Failed to load chartable options');
                            const data = await resp.json();
                            const select = document.getElementById('chartOption');
                            if (data.records && data.records.length > 0) {
                                select.innerHTML = data.records.map(r => `
                                    <option value='${JSON.stringify({type: r.check_template, name: r.item_name})}'>
                                        ${r.label || (r.check_template + ' -> ' + r.item_name)}
                                    </option>
                                `).join('');
                            } else {
                                select.innerHTML = '<option value="">No chartable data</option>';
                            }
                        } catch (e) {
                            console.error(e);
                            document.getElementById('chartOption').innerHTML = '<option value="">Error loading options</option>';
                        }
                    }
            
                    loadMedicalChecks();
                    loadChartableOptions();
                });
            </script>

            <!-- Summary panel -->
            <div class="card mt-3">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span>Summary</span>
                    <button id="sendToAiBtn" class="btn btn-sm btn-info text-white"
                            hx-post="/patients/{{ patient.patient_id }}/send_to_ai"
                            hx-target="#medicalNotes"
                            hx-indicator="#aiProgressBar">Summarise</button>
                </div>
                <div class="card-body">
                    <div id="aiProgressBar" class="progress mb-3 htmx-indicator">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 100%"></div>
                    </div>
                    <div id="medicalNotes" class="border rounded p-3 bg-light" style="min-height: 200px;">
                        {% with ai_response=last_ai_response, patient_id=patient.patient_id %}
                            {% include '_ai_summary.html' %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const patientId = document.getElementById('patient-details-container').dataset.patientId;
            const chartTiles = document.getElementById('chartTiles');
            const addChartTileBtn = document.getElementById('addChartTileBtn');
            const chartOption = document.getElementById('chartOption');
            const sendToAiBtn = document.getElementById('sendToAiBtn');
            const medicalNotes = document.getElementById('medicalNotes');
            const aiProgressBar = document.getElementById('aiProgressBar');

            // HOLD: chartableOptions removed from JS as we'll fetch them via HTMX directly into the select.
            // Let's keep the JS for charts for now as it's heavily Chart.js dependent.

            // --- Dynamic chart tiles ---
            const chartState = new Map(); // key -> { chart, el }

            function normalizeKey(type, name) {
                return `${type}::${(name || '').trim().toLowerCase()}`;
            }

            function createTileElement(type, name) {
                const col = document.createElement('div');
                col.className = 'col';

                const card = document.createElement('div');
                card.className = 'card shadow-sm';

                const header = document.createElement('div');
                header.className = 'card-header d-flex justify-content-between align-items-center';
                header.innerHTML = `<span class="fw-bold">${type} Â· ${name}</span>`;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-outline-danger';
                removeBtn.textContent = 'Remove';
                header.appendChild(removeBtn);

                const body = document.createElement('div');
                body.className = 'card-body';
                const canvas = document.createElement('canvas');
                canvas.height = 160;
                body.appendChild(canvas);

                card.append(header, body);
                col.appendChild(card);

                return { col, canvas, removeBtn };
            }

            async function fetchSeries(type, name) {
                const url = new URL(window.location.origin + `/patients/${patientId}/medical_checks/timeseries`);
                url.searchParams.set('check_template', type);
                url.searchParams.set('item_name', name);
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Failed to load time series');
                const data = await resp.json();
                return Array.isArray(data.records) ? data.records : [];
            }

            function toChartData(records) {
                // records: {date: YYYY-MM-DD, value: str, units: str}
                const labels = [];
                const values = [];
                for (const r of records) {
                    labels.push(r.date);
                    const v = parseFloat(String(r.value).replace(',', '.'));
                    values.push(Number.isFinite(v) ? v : null);
                }
                return { labels, values, unit: (records[0]?.units) || '' };
            }

            function renderChart(ctx, labels, values, label) {
                return new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label,
                            data: values,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.2,
                            spanGaps: true,
                            pointRadius: 3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: { autoSkip: true, maxTicksLimit: 8 }
                            },
                            y: {
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            }

            async function addTileWithImpl(type, name) {
                if (!type || !name) return;
                const key = normalizeKey(type, name);
                if (chartState.has(key)) {
                    return; // already present
                }
                const { col, canvas, removeBtn } = createTileElement(type, name);
                chartTiles.appendChild(col);
                try {
                    const series = await fetchSeries(type, name);
                    const { labels, values, unit } = toChartData(series);
                    const chart = renderChart(canvas.getContext('2d'), labels, values, unit || name);
                    chartState.set(key, { chart, el: col });
                    removeBtn.addEventListener('click', () => removeTile(key));
                } catch (e) {
                    col.querySelector('.card-body').innerHTML = `<div class="text-danger">Failed to load data</div>`;
                }
            }

            function removeTile(key) {
                const state = chartState.get(key);
                if (!state) return;
                try { state.chart.destroy(); } catch (_) {}
                state.el.remove();
                chartState.delete(key);
            }

            window.addTileWith = addTileWithImpl;

            // Process any charts that were requested before DOM was ready
            if (window._earlyCharts) {
                window._earlyCharts.forEach(c => window.addTileWith(c.type, c.name));
                delete window._earlyCharts;
            }

            async function addTile() {
                const raw = chartOption.value;
                if (!raw) {
                    alert('Please select a chart item');
                    return;
                }
                let parsed;
                try { parsed = JSON.parse(raw); } catch { parsed = null; }
                if (!parsed || !parsed.type || !parsed.name) return;
                await window.addTileWith(parsed.type, parsed.name);
            }

            addChartTileBtn.addEventListener('click', addTile);
        });
    </script>
{% endblock %}
