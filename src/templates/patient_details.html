{% extends '_base.html' %}
{% set page_title = "Patient Details" %}

{% block content %}
    <div class="row g-3">
        <!-- Left column -->
        <div class="col-md-6">
            <!-- Patient summary tile -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">Patient Summary</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6"><strong>First Name:</strong></div>
                        <div class="col-6">{{ patient.first_name }}</div>
                        {% if patient.middle_name %}
                            <div class="col-6"><strong>Middle Name:</strong></div>
                            <div class="col-6">{{ patient.middle_name }}</div>
                        {% endif %}
                        <div class="col-6"><strong>Last Name:</strong></div>
                        <div class="col-6">{{ patient.last_name }}</div>
                        <div class="col-6"><strong>Sex:</strong></div>
                        <div class="col-6">{{ patient.sex }}</div>
                        <div class="col-6"><strong>Age:</strong></div>
                        <div class="col-6">{{ age }}</div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Blood Check Results</div>
                <div class="card-body"
                     style="height:220px; display:flex; align-items:center; justify-content:center; color:#6c757d; background: repeating-linear-gradient(45deg, #f8f9fa, #f8f9fa 10px, #ffffff 10px, #ffffff 20px);">
                    <span>Chart placeholder</span>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Weight Over Time</div>
                <div class="card-body"
                     style="height:220px; display:flex; align-items:center; justify-content:center; color:#6c757d; background: repeating-linear-gradient(-45deg, #f8f9fa, #f8f9fa 10px, #ffffff 10px, #ffffff 20px);">
                    <span>Chart placeholder</span>
                </div>
            </div>
        </div>

        <!-- Right column -->
        <div class="col-md-6">
            <!-- Combined controls + history -->
            <div class="card">
                <div class="card-header bg-info text-white">Medical checks</div>
                <div class="card-body">
                    <!-- Top: Add control -->
                    <div class="d-flex gap-2 align-items-center flex-wrap mb-3">
                        <select id="checkType" class="form-select" style="max-width: 240px;">
                            <option value="physicals">physicals</option>
                            <option value="blood">blood</option>
                            <option value="colonoscopy">colonoscopy</option>
                        </select>
                        <button id="addRecordBtn" class="btn btn-primary">Add Record</button>
                    </div>

                    <!-- Bottom: tiles list -->
                    <div id="noRecords" class="text-muted" style="display:none;">No records yet.</div>
                    <div id="checksTiles" class="row row-cols-1 row-cols-sm-2 g-2">
                        <!-- populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const patientId = {{ patient.patient_id }};
            const tiles = document.getElementById('checksTiles');
            const noRecords = document.getElementById('noRecords');

            function render(records) {
                tiles.innerHTML = '';
                if (!records || records.length === 0) {
                    noRecords.style.display = '';
                    return;
                }
                noRecords.style.display = 'none';
                for (const r of records) {
                    const col = document.createElement('div');
                    col.className = 'col';

                    const card = document.createElement('div');
                    card.className = 'border rounded p-2 h-100';

                    const type = document.createElement('div');
                    type.className = 'fw-bold';
                    type.textContent = r.type || '';

                    const date = document.createElement('div');
                    date.className = 'text-muted';
                    date.textContent = r.date || '';

                    const status = document.createElement('span');
                    status.className = 'badge ms-2';
                    const sVal = r.status || '';
                    status.textContent = sVal;
                    // Color code badge and tile background based on status
                    if (sVal === 'Red') {
                        status.classList.add('bg-danger');
                        card.classList.add('bg-danger', 'text-white');
                    } else if (sVal === 'Amber') {
                        status.classList.add('bg-warning', 'text-dark');
                        card.classList.add('bg-warning', 'text-dark');
                    } else if (sVal === 'Green') {
                        status.classList.add('bg-success');
                        card.classList.add('bg-success', 'text-white');
                    }

                    const header = document.createElement('div');
                    header.append(type, status);

                    card.append(header, date);
                    col.appendChild(card);
                    tiles.appendChild(col);
                }
            }

            fetch(`/patients/${patientId}/medical_checks`)
                .then(r => r.json())
                .then(data => render(data.records))
                .catch(() => render([]));

            // Placeholder action for Add Record
            document.getElementById('addRecordBtn').addEventListener('click', () => {
                const type = document.getElementById('checkType').value;
                alert(`Add Record clicked for type: ${type} (not implemented)`);
            });
        });
    </script>
{% endblock %}
