{% extends '_base.html' %}
{% set page_title = "Patient Details" %}

{% block content %}
    <div class="row g-3">
        <!-- Left column -->
        <div class="col-md-6">
            {% include '_patient_summary_card.html' %}

            <div class="card mb-3">
                <div class="card-header">Blood Check Results</div>
                <div class="card-body chart-placeholder-diag">
                    <span>Chart placeholder</span>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Weight Over Time</div>
                <div class="card-body chart-placeholder-anti">
                    <span>Chart placeholder</span>
                </div>
            </div>
        </div>

        <!-- Right column -->
        <div class="col-md-6">
            <!-- Combined controls + history -->
            <div class="card">
                <div class="card-header bg-info text-white">Medical checks</div>
                <div class="card-body">
                    <!-- Top: Add control -->
                    <div class="d-flex gap-2 align-items-center flex-wrap mb-3">
                        <select id="checkType" class="form-select" style="max-width: 240px;">
                            <option value="physicals">physicals</option>
                            <option value="blood">blood</option>
                            <option value="colonoscopy">colonoscopy</option>
                        </select>
                        <button id="addRecordBtn" class="btn btn-primary">Add Record</button>
                    </div>

                    <!-- Bottom: tiles list -->
                    <div id="noRecords" class="text-muted" style="display:none;">No records yet.</div>
                    <div id="checksTiles" class="row row-cols-1 g-2">
                        <!-- populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const patientId = {{ patient.patient_id }};
            const tiles = document.getElementById('checksTiles');
            const noRecords = document.getElementById('noRecords');

            function render(records) {
                tiles.innerHTML = '';
                if (!records || records.length === 0) {
                    noRecords.style.display = '';
                    return;
                }
                noRecords.style.display = 'none';
                for (const r of records) {
                    const col = document.createElement('div');
                    col.className = 'col';

                    const card = document.createElement('div');
                    card.className = 'border rounded py-2 px-3 d-flex justify-content-between align-items-center';
                    if (r.check_id) {
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => {
                            window.location.href = `/patients/${patientId}/medical_checks/${r.check_id}`;
                        });
                        card.title = 'View details';
                    }

                    const type = document.createElement('div');
                    type.className = 'fw-bold text-truncate';
                    type.textContent = r.type || '';

                    const date = document.createElement('div');
                    date.className = 'text-muted ms-3';
                    date.textContent = r.date || '';

                    const sVal = r.status || '';
                    if (sVal === 'Red') {
                        card.classList.add('bg-danger', 'text-white');
                    } else if (sVal === 'Amber') {
                        card.classList.add('bg-warning', 'text-dark');
                    } else if (sVal === 'Green') {
                        card.classList.add('bg-success', 'text-white');
                    }

                    card.append(type, date);
                    col.appendChild(card);
                    tiles.appendChild(col);
                }
            }

            fetch(`/patients/${patientId}/medical_checks`)
                .then(r => r.json())
                .then(data => render(data.records))
                .catch(() => render([]));

            // Redirect to specific add page based on selected type
            document.getElementById('addRecordBtn').addEventListener('click', () => {
                const type = document.getElementById('checkType').value;
                if (type === 'physicals') {
                    window.location.href = `/patients/${patientId}/medical_checks/physicals/new`;
                } else {
                    alert(`Add page for type: ${type} is not implemented yet.`);
                }
            });
        });
    </script>
{% endblock %}
